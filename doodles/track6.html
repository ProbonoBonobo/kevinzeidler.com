<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="../js/querty-hancock.js"></script>

</head>
<body>
   <div id="keyboard"></div>
<script>
    window.AudioContext = window.AudioContext || window.webkitAudioContext;

    var scales = {

        "G": [ 369.99,  392.00,  440.00, 493.88, 523.25,  587.33, 659.25]
    };

    var note2Freq = {
        "A" : 27.5000,
        "A#" : 29.1352,
        "B" : 30.8677,
        "C" : 32.7032,
        "C#" : 34.6478,
        "D" : 36.7081,
        "D#" : 38.8909,
        "E" : 41.2034,
        "F": 43.6535,
        "F#": 46.2493,
        "G": 48.9994,
        "G#": 51.9131
    };

    var     A="A",
            B = "B",
            C = "C",
            D = "D",
            E = "E",
            F = "F",
            G = "G",
            Gsharp = "G#",
            Aflat = "G#",
            Asharp = "A#",
            Bflat = "A#",
            Csharp = "C#",
            Dflat = "C#",
            Dsharp = "D#",
            Eflat = "D#",
            Fsharp = "F#",
            Gflat = "F#";


    function scale2Notes(scale) {
        var scales = {
            "C Major": [ C,
                         D,
                         E,
                         F,
                         G,
                         A,
                         B,
                         C ],
            "C Melodic Minor": [ C,
                                 D,
                                 Eflat,
                                 F,
                                 G,
                                 A,
                                 B,
                                 C ],
            "C Dorian" : [C, D, Eflat, F, G, A, Bflat, C],
            "C Lydian" : [C, D, E, Fsharp, G, A, B],
            "C Phrygian" : [C, Dflat, Eflat, F, G, Aflat, Bflat, C],
            "C Locrian" : [C, Dflat, Eflat, F, Gflat, Aflat, Bflat, C]

        };

        if (!scales[scale]) {
            alert("I don't know the " + scale + " scale. I only know: " + Object.keys(scales) + ". You could add " + scale + "!");
        }
        return scales[scale];
    }

    function scale2Freqs(octave) {
        var freqArr = scale2Notes(scale2Notes);
        return freqArr.map(function(x) {
            return x * Math.pow(2, octave);
        })
    }



    function permutations(len) {
        arr = new Array(len);
        // do later

        switch (len) {
            case 2:
                arr = [[[1],[1]], [[2,2]]];
                return arr;
            case 3:
                arr = [[[1],[1],[1]], [[2,2],[1]], [[1,1],[2]], [[3,3,3]]];
                return arr;
            case 4:
                arr = [[[1],[1],[1],[1]], [[2,2],[1],[1]], [[1],[2,2],[1]], [[1],[1],[2,2]], [[2,2],[2,2]], [[3,3,3],[1]], [[1],[3,3,3]], [[4,4,4,4]]];
                return arr;

        }

        return arr;
    }


    var context = new AudioContext(),
            settings = {
                id: 'keyboard',
                width: 600,
                height: 150,
                startNote: 'A2',
                whiteNotesColour: '#fff',
                blackNotesColour: '#000',
                borderColour: '#000',
                activeColour: 'yellow',
                octaves: 2
            },
            keyboard = new QwertyHancock(settings);

    masterGain = context.createGain();
    nodes = [];

    masterGain.gain.value = 0.3;
    masterGain.connect(context.destination);

    keyboard.keyDown = function (note, frequency) {
        var oscillator = context.createOscillator();
        oscillator.type = 'triangle';
        oscillator.frequency.value = frequency;
        oscillator.connect(masterGain);
        oscillator.start(0);

        nodes.push(oscillator);
    };
    keyboard.keyUp = function (note, frequency) {
        var new_nodes = [];

        for (var i = 0; i < nodes.length; i++) {
            if (Math.round(nodes[i].frequency.value) === Math.round(frequency)) {
                nodes[i].stop(0);
                nodes[i].disconnect();
            } else {
                new_nodes.push(nodes[i]);
            }
        }

        nodes = new_nodes;
    };

    function generateMelody(timeSig, scale, octave, numberOfBars, tempo) {
        var notes = scale2Notes(scale).map(function(note) { return (note2Freq[note]*Math.pow(2,octave)); } ),
            beats = permutations(timeSig ),
            duration = (1/timeSig) * tempo,
            musicTuples = [];
        console.log(notes);

        function randRange(min, max) {
            return Math.floor(Math.random() * (max - min)) + min;
        }
        console.log(randRange(0,beats.length));

        for (var i = 0; i < numberOfBars; i++) {
            var beatsThisBar = beats[randRange(0, beats.length )];
            for (var j = 0; j < beatsThisBar.length; j++) {
                var note = beatsThisBar[j];
                console.log(note.length*duration, notes[randRange(0, 7)]);
                musicTuples.push([note.length*duration, notes[randRange(0, 7)]]);
            }


        }

        return musicTuples;
    }

    function play(noteArr) {
        if (noteArr && noteArr.length > 0) {
                var note = noteArr.pop();
                if ( note && note.length === 2 ) {
                    keyboard.keyDown( note[ 1 ], note[ 1 ] );
                    setTimeout( function () {
                                    keyboard.keyUp( note[ 1 ], note[ 1 ] );
                                    return play(noteArr);
                                }, note[ 0 ]
                    );

                }
            }
        else {
//            return play(generateMelody(4, "C Dorian", 2, 20, 1000));
        }
    }

    var song = generateMelody(4, "C Locrian", 2, 100, 800);
    var song2 = generateMelody(3, "C Locrian", 1, 100, 600);
    var song3 = generateMelody(2, "C Locrian", 3, 100, 400);


    play(song);
    play(song2);
    play(song3);




</script>

</body>
</html>